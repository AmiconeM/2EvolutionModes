---
title: "Frequency Propagator Analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(writexl)
library(RColorBrewer)
library(xlsx)
```

## What conditions do you want to compare?
Set the parameters that correspond to the conditions you want to analyse.
```{r, set parameters}
# parameters to change

model="DirSel_Gamma_shape1"                    ## model used for the simulations
Us=c(10^(-9),10^(-8),10^(-7),10^(-6),10^(-5))  ## mutation rates used for the simulations
N=10^7                                         ## pop size used for the simulations
Pb=1                                           ## proportion of ben. mutations used for the simulations
Delta=0.05                                     ## expected mutation effect used for the simulations
simulations=20                                 ## number of simulations
seed=0                                         ## random seed used for the simulations
t_tot=10000                                    ## number of generations used for the simulations
p_sample=100                                   ## sampling period
inFit=1                                        ## initial population fitness used for the simulations

```

## Color code for the different conditions  
The colors will distinguish the different mutation rate conditions.
Change pallette in case you need more than 9.
```{r,colors}
colors=brewer.pal(n=length(Us),name="Set1") ### change pallette in case you need more than 9 colors
light_colors=c()                            ### to create the same colors but 20% transparent
med_colors=c()                              ### to create the same colors but 50% transparent
for(i in 1:length(Us)){
  col=col2rgb(colors[i])
  c_light=rgb(col[1]/255,col[2]/255,col[3]/255,0.8)
  c_med=rgb(col[1]/255,col[2]/255,col[3]/255,0.5)
  light_colors=c(light_colors,c_light)
  med_colors=c(med_colors,c_med)
}
```

```{r,colors2}
color_range <- colorRampPalette(c("#2D3919", "#99BB63"))
colors=color_range(length(Us)) 
#colors=brewer.pal(n=length(Us),name="Set1") ### change pallette in case you need more than 9 colors
light_colors=c()                            ### to create the same colors but 20% transparent
med_colors=c()                              ### to create the same colors but 50% transparent
for(i in 1:length(Us)){
  col=col2rgb(colors[i])
  c_light=rgb(col[1]/255,col[2]/255,col[3]/255,0.8)
  c_med=rgb(col[1]/255,col[2]/255,col[3]/255,0.5)
  light_colors=c(light_colors,c_light)
  med_colors=c(med_colors,c_med)
}
```

## If you need to compute the frequency propagator, run the next box (called "compute propagator").
## If you have computed it previously, upload directly the propagator file from box "load pre-analyzed dataset".


## Load mutation trajectories and compute propagator 
The next box will import the data from different mutation rate conditions, compile them in a dataframe called Prop_Data and export an Excel file with the analysed propagator data.  
For each population this code performs the following steps:
i) count the number of observed mutations  
ii) compute the proportion of mutations that have reached a given frequency, f.
(here f takes the values between 0 and 1, with intervals of 0.01 (e.g. 0, 0.01, 0.02, ...))  
iii) export a table with propagator frequencies for each population/condition.
```{r,compute propagator}
rm(PROP)

NU_b=c()
Model=c()
W0=c()
Mut_effect=c()
pop_ID=c()
interv=0.01
freq=seq(0,1,interv)

t_final=10000 ## final time point
t_column=t_final/100 +3 ##set the data column (time point) where to stop the analysis

for(u in 1:length(Us)){
  ##load data
  input_file=paste("Data_U",Us[u],"_N1e+07_Delta",Delta,"_Pb",Pb,"_W0_",inFit,"_",t_tot,"gen_",simulations,"sim_seed",seed,"_",model,"/Mut_Trajectories_U",Us[u],"_N1e+07_Delta",Delta,"_Pb",Pb,"_W0_",inFit,"_",t_tot,"gen_",simulations,"sim_seed",seed,"_",model,".csv",sep="")
  data=read.table(file=input_file,header = T,sep =",")
  t_sample=colnames(data)[3:dim(data)[2]]
  
  ## compute Propagator for each population
  for(replica in 1:simulations){
    print(paste("U:",Us[u],", replica:",replica),sep="")
    NU_b=c(NU_b,N*Us[u]*Pb)
    Model=c(Model,model)
    pop_ID=c(pop_ID,replica)
    W0=c(W0,inFit)
    Mut_effect=c(Mut_effect,Delta)
    
    data_p=data[which(data$pop_ID==replica),3:t_column]
    Prop=c()
    
    ## i) count the number of observed mutations
    nmut=dim(data_p)[1]   
    max_f=c()
    if(nmut>0){
      for(j in 1:nmut){
          max_f=c(max_f,max(data_p[j,]))
      }
      
    ## ii) compute the proportion of mutations that have reached a given frequency, f.
    ##(here f takes the values between 0 and 1, with intervals of 0.01 (e.g. 0, 0.01, 0.02, ...))  
      for(i in 1:length(freq)){
        x=length(which(max_f>=freq[i]))
        Prop=c(Prop,x/nmut)
      }
    }else{Prop=rep(NA,length(freq))}
    
    PROP=rbind(get0("PROP"),Prop)
    }
}

colnames(PROP)=freq
Prop_Data=data.frame(NU_b,Mut_effect,W0,Model,pop_ID,PROP)

## iii) export a table with propagator frequencies for each population/condition.
write_xlsx(Prop_Data, paste("Propagator_",model,"_s",Delta,"_",t_final,"generations",".xlsx",sep=""))
```

##Load Propagator data
```{r, load pre-analyzed dataset}
t_final=10000 ## final time point
Prop_Data=read.xlsx(paste("Propagator_",model,"_s",Delta,"_",t_final,"generations",".xlsx",sep=""),sheetIndex = 1)
interv=0.01
freq=seq(0,1,interv)
```

##Plotting
Thin lines represent single populations.
Thick lines represent the mean across populations.
```{r,Plot Propagator across NUb}


colnames(Prop_Data)=c("NUb","Mutation effect","W0","Model","pop_ID",freq)
Prop_Data$NUb=as.factor(Prop_Data$NUb)
x=freq
y=Prop_Data[1,6:dim(Prop_Data)[2]]
Prop_Data$NUb=as.factor(Prop_Data$NUb)

Y_means=matrix(0,nrow = length(Us),ncol=length(freq))
Y_SEMs=matrix(0,nrow = length(Us),ncol=length(freq))

title=expression("Directional selection ("  ~  hat(s) ~  "=" ~ 0.05 ~ ", N ="~ 10^7 ~")")
#tiff(file=paste("Propagator_",model,"_s",Delta,"_all.tiff",sep=""),width=6, height=5,res = 300,units = "in")
png(file=paste("Propagator_",model,"_s",Delta,"_",t_final,"generations.png",sep=""),width=5, height=5,res = 600,units = "in")
par(las=1,mar=c(5.1, 4.1, 4.1, 7.1), xpd=TRUE)
plot(x=x,y=y,type='n',xlab="",ylab="",xaxt='n',yaxt='n',ylim=c(0,1),xlim=c(0,1))
segments(x0=0,x1=1,y0=1,y1=1,lty=2,lwd=3,col="#161D0C")
for(u in 1:length(Us)){
  nu_b=N*Pb*Us[u]
  data=Prop_Data[which(Prop_Data$NUb==nu_b),6:dim(Prop_Data)[2]]
  y_mean=colMeans(data,na.rm = T)
  y_SEM=c()
  for(i in 1:length(y_mean)){
    SD=sd(data[,i],na.rm = T)
    y_SEM=c(y_SEM,2*SD/sqrt(simulations))
  }
  
  Y_means[u,]=y_mean
  Y_SEMs[u,]=y_SEM
  
  for(pop in 1:simulations){
    y=data[pop,]
    lines(x=x,y=y,col=colors[u],lwd=0.3)
  }
  
}
for(u in length(Us):1){
  sem=Y_means[u,]+ outer(Y_SEMs[u,], c(1,-1))
  polygon(c(freq,rev(freq)), c(sem[,1],rev(sem[,2])),border=NA, col=med_colors[u])
  lines(x=x,y=Y_means[u,],col=colors[u],lwd=4)
}

xtick=seq(0,1,length.out = 6)
axis(side=1,at=xtick,tck=-0.01,labels = FALSE)
text(x=xtick,  par("usr")[3],labels = xtick,pos = 1, xpd = TRUE)

ytick=seq(0,1,length.out = 6)
axis(side=2,at=ytick,tck=-0.01,labels = FALSE)
text(par("usr")[1], ytick,labels = ytick, pos = 2, xpd = TRUE)

title(xlab = "Frequency, x", mgp = c(1.5,1,0))    # Add x-axis text
title(ylab = "Probability to reach x", mgp = c(2, 1, 0))    # Add y-axis text
legend("right", bty = "n", col=colors,pch=15,cex=1.5,legend = levels(Prop_Data$NUb),title = expression(NU[b]),inset=c(-0.4,0),pt.cex = 3)
dev.off()

```



